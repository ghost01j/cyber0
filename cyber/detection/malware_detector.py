import os
import hashlib
import psutil
import logging
import time
from collections import defaultdict
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
from colorama import Fore, init

init(autoreset=True)

# ---------------- CONFIG ----------------
LOG_FILE = "malware_detection.log"
RISK_SCORE_LIMIT = 50

SUSPICIOUS_EXTENSIONS = [
    ".exe", ".bat", ".vbs", ".ps1",
    ".scr", ".dll", ".js", ".jar"
]

SOCIAL_ENGINEERING_NAMES = [
    "invoice", "salary", "urgent",
    "password", "bank", "update"
]

KNOWN_MALWARE_HASHES = {
    "44d88612fea8a8f36de82e1278abb02f"
}

suspicious_process_keywords = [
    "hack", "keylog", "inject",
    "ransom", "miner", "spy"
]

logging.basicConfig(
    filename=LOG_FILE,
    level=logging.INFO,
    format="%(asctime)s - %(message)s"
)

# ---------------- STORAGE ----------------
file_activity_counter = defaultdict(int)


# ---------------- HASH GENERATOR ----------------
def generate_hash(filepath):
    sha256 = hashlib.sha256()
    try:
        with open(filepath, "rb") as f:
            for chunk in iter(lambda: f.read(4096), b""):
                sha256.update(chunk)
        return sha256.hexdigest()
    except:
        return None


# ---------------- CORE FILE ANALYSIS ----------------
def analyze_file(filepath):

    risk_score = 0

    print(Fore.CYAN + f"[SCAN] Checking file: {filepath}")

    if not os.path.exists(filepath):
        return

    filename = os.path.basename(filepath).lower()

    # 1️⃣ Suspicious Extension
    _, ext = os.path.splitext(filename)
    if ext in SUSPICIOUS_EXTENSIONS:
        risk_score += 15
        print(Fore.YELLOW + "[WARN] Suspicious extension detected")

    # 2️⃣ Social Engineering Filename
    if any(word in filename for word in SOCIAL_ENGINEERING_NAMES):
        risk_score += 20
        print(Fore.YELLOW + "[WARN] Possible social engineering filename")

    # 3️⃣ Malware Hash Check
    file_hash = generate_hash(filepath)
    if file_hash in KNOWN_MALWARE_HASHES:
        risk_score += 50
        print(Fore.RED + "[ALERT] Known malware signature matched")

    # 4️⃣ Ransomware Behavior Simulation (mass renaming)
    file_activity_counter[filename] += 1
    if file_activity_counter[filename] > 5:
        risk_score += 30
        print(Fore.RED + "[ALERT] Possible ransomware behavior")

    # 5️⃣ Decision
    if risk_score >= RISK_SCORE_LIMIT:
        print(Fore.RED + f"[CRITICAL] Malware detected! Score: {risk_score}")
        logging.critical(f"Malware detected: {filepath}")
    else:
        print(Fore.GREEN + f"[SAFE] File looks clean | Score: {risk_score}")


# ---------------- PROCESS MONITORING ----------------
def monitor_processes():

    print(Fore.GREEN + "[INFO] Monitoring processes...")

    for proc in psutil.process_iter(['pid', 'name']):
        try:
            name = proc.info['name'].lower()

            if any(keyword in name for keyword in suspicious_process_keywords):
                print(Fore.RED + f"[ALERT] Suspicious process detected: {name}")
                logging.critical(f"Suspicious process: {name}")

        except:
            continue


# ---------------- REAL-TIME FILE MONITOR ----------------
class MalwareEventHandler(FileSystemEventHandler):
    def on_created(self, event):
        if not event.is_directory:
            analyze_file(event.src_path)


def start_realtime_monitor(path):

    event_handler = MalwareEventHandler()
    observer = Observer()
    observer.schedule(event_handler, path, recursive=True)
    observer.start()

    print(Fore.GREEN + "[INFO] Real-time monitoring started")

    try:
        while True:
            time.sleep(2)
    except KeyboardInterrupt:
        observer.stop()

    observer.join()


# ---------------- FULL DIRECTORY SCAN ----------------
def scan_directory(path):

    print(Fore.BLUE + "[INFO] Starting full system scan...")

    for root, dirs, files in os.walk(path):
        for file in files:
            analyze_file(os.path.join(root, file))

    monitor_processes()


# ---------------- WRAPPER ----------------
def run_malware_module(path):
    scan_directory(path)


# ---------------- TEST ----------------
if __name__ == "__main__":

    print("=== MALWARE DETECTOR TEST MODE ===")
    test_path = "C:/Users"
    scan_directory(test_path)